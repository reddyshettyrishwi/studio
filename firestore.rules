
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      // In a real app, this would check for a custom claim or a specific role in the database.
      // For this demo, we'll assume any signed-in user can be an admin for approval purposes.
      // This is NOT secure for production.
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    match /users/{userId} {
      // VALIDATION: Ensure incoming user data has the correct fields and types.
      function isNewUserDataValid() {
        let data = request.resource.data;
        return data.name is string &&
               data.email is string &&
               data.role is string && (data.role == 'Manager' || data.role == 'Executive' || data.role == 'Admin') &&
               data.status is string && (data.status == 'Pending' || data.status == 'Approved') &&
               data.keys().hasAll(['name', 'email', 'role', 'status']);
      }
      
      function isStatusUpdateValid() {
        let data = request.resource.data;
        // Check that only 'status' is being updated.
        return data.keys().hasOnly(['status']) && 
               data.status is string && 
               (data.status == 'Approved' || data.status == 'Rejected'); // Or other valid statuses
      }

      // SECURITY:
      // Allow a user to read their own profile.
      allow get: if isOwner(userId);

      // Do not allow anyone to list all users.
      allow list: if false;

      // Allow a user to create their own user document if the data is valid.
      // This is crucial for social sign-ins where the user record is created after authentication.
      allow create: if isOwner(userId) && isNewUserDataValid();

      // Allow an admin to update a user's status (e.g., for approvals).
      // Allow a user to update limited fields on their own profile (not implemented here, but possible).
      allow update: if isAdmin() && isStatusUpdateValid();
                       
      // Allow a user to delete their own account.
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows admins to manage agencies.
     * @path /agencies/{agencyId}
     * @allow (create) request.auth.uid == 'admin_user'
     * @allow (get, list) true
     * @deny (update, delete) request.auth.uid != 'admin_user'
     * @principle Restricts agency management to authorized users.
     */
    match /agencies/{agencyId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Controls access to influencer profiles based on agency association.
     * @path /influencers/{influencerId}
     * @allow (get, list) true
     * @allow (create) request.resource.data.agencyId != null  // Example: Allow creation if associated with an agency.
     * @deny (update, delete) false // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Manages access based on agency association.
     */
    match /influencers/{influencerId} {
      allow get, list: if true; // Allow public read access.

      // Allow any signed-in user to create, update, or delete influencers for now.
      // In a real app, this would be restricted to 'Managers' or 'Admins'.
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Manages access to campaigns.
     * @path /campaigns/{campaignId}
     * @allow (get, list) true
     * @deny (create, update, delete) false // TODO: Add owner validation once the schema is updated with an ownership field.
     * @principle Controls access to campaigns.
     */
    match /campaigns/{campaignId} {
      allow get, list: if true;

      // Allow any signed-in user to create, update, or delete campaigns for now.
      // In a real app, this would be restricted to 'Managers'.
      allow create, update, delete: if isSignedIn();
    }
  }
}
