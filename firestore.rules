
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      // In a real app, this would check for a custom claim or a specific role in the database.
      // For this demo, we'll check a 'role' field on the user's document.
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    match /users/{userId} {
      // VALIDATION: Ensure incoming user data has the correct fields and types.
      function isNewUserDataValid() {
        let data = request.resource.data;
        return data.name is string &&
               data.email is string &&
               data.role is string &&
               data.status is string &&
               data.keys().hasAll(['name', 'email', 'role', 'status']);
      }
      
      function isStatusUpdateValid() {
        let data = request.resource.data;
        // Check that only 'status' is being updated.
        return data.keys().hasOnly(['status']) && 
               data.status is string && 
               (data.status == 'Approved' || data.status == 'Rejected');
      }

      // SECURITY:
      // Allow a user to read their own profile.
      allow get: if isOwner(userId);

      // Do not allow anyone to list all users.
      allow list: if isSignedIn() && query.get("status") == "Pending" && isAdmin();


      // Allow a user to create their own user document if the data is valid.
      allow create: if isOwner(userId) && isNewUserDataValid();

      // Allow an admin to update a user's status (e.g., for approvals).
      allow update: if isAdmin() && isStatusUpdateValid();
                       
      // Allow a user to delete their own account.
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows admins to manage agencies. Any signed-in user can read.
     */
    match /agencies/{agencyId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Controls access to influencer profiles. Any signed-in user can read.
     */
    match /influencers/{influencerId} {
      allow get, list: if isSignedIn();

      // Allow any signed-in user to create, update, or delete influencers for now.
      // In a real app, this would be restricted to 'Managers' or 'Admins'.
      allow create, update, delete: if isSignedIn();
    }

    /**
     * @description Manages access to campaigns. Any signed-in user can read.
     */
    match /campaigns/{campaignId} {
      allow get, list: if isSignedIn();

      // Allow any signed-in user to create, update, or delete campaigns for now.
      // In a real app, this would be restricted to 'Managers'.
      allow create, update, delete: if isSignedIn();
    }
  }
}
